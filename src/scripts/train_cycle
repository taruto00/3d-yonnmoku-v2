# =====================================================
# One-runtime AlphaZero ç«‹ä½“å››ç›®  å­¦ç¿’ãƒ«ãƒ¼ãƒ—
#   ãƒ»Google Drive ã«ãƒ¢ãƒ‡ãƒ«ï¼ãƒ‡ãƒ¼ã‚¿ï¼state ã‚’ç›´ä¿å­˜
#   ãƒ»é€”ä¸­ã‚µã‚¤ã‚¯ãƒ«ã‹ã‚‰å†é–‹
# =====================================================
import os, json, time, shutil
from pathlib import Path
from google.colab import drive
from tensorflow.keras import backend as K

# ---------- 0) Google Drive ----------
drive.mount('/content/drive', force_remount=False)

ROOT = Path('/content/drive/MyDrive/azero_3d')
MODEL_DIR = ROOT / 'model'
DATA_DIR  = ROOT / 'data'
MODEL_DIR.mkdir(parents=True, exist_ok=True)
DATA_DIR.mkdir(exist_ok=True)

# ---------- 1) ã‚³ãƒ¼ãƒ‰ç½®ãå ´ã«ç§»å‹• ----------
%cd /content/drive/MyDrive/sample/3dyonnmoku/train_code_3
import sys; sys.path.append(os.getcwd())

# ---------- 2) ãƒ¦ãƒ¼ã‚¶ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ----------
from dual_network      import dual_network
from self_play import self_play   # ãƒ†ã‚¹ãƒˆç¾åœ¨500
from train_network     import train_network
from evaluate_network  import evaluate_network
from evaluate_best_player import evaluate_best_player

BEST_PATH  = MODEL_DIR / 'best_v2.h5'
STATE_JSON = ROOT / 'state_v2.json'

# ---------- 3) åˆæœŸ best_v2.h5 ----------
if not BEST_PATH.exists():
    dual_network()                                 # ./model/best_v2.h5 ã‚’ç”Ÿæˆ
    shutil.copy('./model/best_v2.h5', BEST_PATH)      # â˜… Drive å´ã¸ã‚‚ä¿å­˜
else:
    print("ğŸ”„  best_v2.h5 ã‚’å†åˆ©ç”¨")
    shutil.copy(BEST_PATH, './model/best_v2.h5')      # â˜… Drive â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã«å¿…ãšã‚³ãƒ”ãƒ¼


# ---------- 4) å†é–‹ãƒã‚¤ãƒ³ãƒˆ ----------
start_cycle = 0
if STATE_JSON.exists():
    start_cycle = json.load(STATE_JSON.open())['cycle'] + 1
    print(f"â–¶ å†é–‹: cycle {start_cycle}")

TOTAL_CYCLES = 10          #ãƒ†ã‚¹ãƒˆ 10â†’3

# ---------- 5) ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ----------
for cycle in range(start_cycle, TOTAL_CYCLES):
    print(f"\n===== CYCLE {cycle+1}/{TOTAL_CYCLES} =====")
    self_play()                   # â‘  è‡ªå·±å¯¾æˆ¦
    train_network()               # â‘¡ å†å­¦ç¿’
    updated = evaluate_network()  # â‘¢ best æ›´æ–°åˆ¤å®š
    if updated:
        evaluate_best_player()    # â‘£ ä»»æ„ãƒ†ã‚¹ãƒˆ

    # â‘¤ latest ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    shutil.copy('./model/latest_v2.h5', MODEL_DIR / f'latest_v2_{cycle:02d}.h5')

    # best ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã¯ä¸¡æ–¹å‘ã§åŒæœŸ
    if updated:
        shutil.copy('./model/best_v2.h5', BEST_PATH)          # ãƒ­ãƒ¼ã‚«ãƒ«â†’Drive
    else:
        shutil.copy(BEST_PATH, './model/best_v2.h5')          # Driveâ†’ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆå¿µã®ãŸã‚ï¼‰

    # â‘¥ state æ›´æ–°
    json.dump({'cycle': cycle,
               'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')},
              STATE_JSON.open('w'))

    # â‘¦ ãƒ¡ãƒ¢ãƒªè§£æ”¾
    K.clear_session()

print("\nğŸ‰ ã™ã¹ã¦å®Œäº†  â€¢  best =", BEST_PATH)

# å…¨å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
print("å…¨å­¦ç¿’å®Œäº†ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
import os
os.kill(os.getpid(), 9)
